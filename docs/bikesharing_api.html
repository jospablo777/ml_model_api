<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jose P. Barrantes">
<meta name="description" content="GitHub Repo: Bike Rentals Prediction API">

<title>Bike Rentals Prediction API</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link rel="shortcut icon" href="img/favicon.png">


</head>

<body>

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#an-accesible-inference-system" id="toc-an-accesible-inference-system" class="nav-link active" data-scroll-target="#an-accesible-inference-system">An accesible inference system</a></li>
  <li><a href="#an-ml-model-as-a-microservice" id="toc-an-ml-model-as-a-microservice" class="nav-link" data-scroll-target="#an-ml-model-as-a-microservice">An ML model as a microservice</a></li>
  <li><a href="#but-what-is-an-api" id="toc-but-what-is-an-api" class="nav-link" data-scroll-target="#but-what-is-an-api">But what is an API?</a></li>
  <li><a href="#software-engineering-for-data-scientists" id="toc-software-engineering-for-data-scientists" class="nav-link" data-scroll-target="#software-engineering-for-data-scientists">Software engineering for data scientists</a></li>
  <li><a href="#about-the-technologies" id="toc-about-the-technologies" class="nav-link" data-scroll-target="#about-the-technologies">About the technologies</a></li>
  <li><a href="#lets-get-started" id="toc-lets-get-started" class="nav-link" data-scroll-target="#lets-get-started">Let’s get started</a></li>
  <li><a href="#problem-we-want-to-solve" id="toc-problem-we-want-to-solve" class="nav-link" data-scroll-target="#problem-we-want-to-solve">Problem we want to solve</a></li>
  <li><a href="#microservice-development" id="toc-microservice-development" class="nav-link" data-scroll-target="#microservice-development">Microservice development</a></li>
  <li><a href="#api-development" id="toc-api-development" class="nav-link" data-scroll-target="#api-development">API development</a>
  <ul class="collapse">
  <li><a href="#defining-the-pydantic-model" id="toc-defining-the-pydantic-model" class="nav-link" data-scroll-target="#defining-the-pydantic-model">Defining the Pydantic model</a></li>
  <li><a href="#fastapi-development" id="toc-fastapi-development" class="nav-link" data-scroll-target="#fastapi-development">FastAPI development</a></li>
  <li><a href="#pydantic-model" id="toc-pydantic-model" class="nav-link" data-scroll-target="#pydantic-model">Pydantic model</a></li>
  <li><a href="#fastapi-app" id="toc-fastapi-app" class="nav-link" data-scroll-target="#fastapi-app">FastAPI app</a></li>
  </ul></li>
  <li><a href="#cicd-continuous-integration-continuos-deployment" id="toc-cicd-continuous-integration-continuos-deployment" class="nav-link" data-scroll-target="#cicd-continuous-integration-continuos-deployment">CI/CD (Continuous Integration / Continuos Deployment)</a>
  <ul class="collapse">
  <li><a href="#our-customization" id="toc-our-customization" class="nav-link" data-scroll-target="#our-customization">Our Customization</a></li>
  </ul></li>
  <li><a href="#automated-tests" id="toc-automated-tests" class="nav-link" data-scroll-target="#automated-tests">Automated tests</a>
  <ul class="collapse">
  <li><a href="#api-tests" id="toc-api-tests" class="nav-link" data-scroll-target="#api-tests">API tests</a></li>
  <li><a href="#inference-tests" id="toc-inference-tests" class="nav-link" data-scroll-target="#inference-tests">Inference tests</a></li>
  <li><a href="#running-the-tests" id="toc-running-the-tests" class="nav-link" data-scroll-target="#running-the-tests">Running the tests</a></li>
  </ul></li>
  <li><a href="#microservice-up-and-running" id="toc-microservice-up-and-running" class="nav-link" data-scroll-target="#microservice-up-and-running">Microservice up and running</a>
  <ul class="collapse">
  <li><a href="#step-1-pull-the-image-from-docker-hub" id="toc-step-1-pull-the-image-from-docker-hub" class="nav-link" data-scroll-target="#step-1-pull-the-image-from-docker-hub">Step 1: Pull the Image from Docker Hub</a></li>
  <li><a href="#step-2-run-the-docker-container" id="toc-step-2-run-the-docker-container" class="nav-link" data-scroll-target="#step-2-run-the-docker-container">Step 2: Run the Docker Container</a></li>
  <li><a href="#step-3-access-the-api" id="toc-step-3-access-the-api" class="nav-link" data-scroll-target="#step-3-access-the-api">Step 3: Access the API</a></li>
  </ul></li>
  <li><a href="#inference" id="toc-inference" class="nav-link" data-scroll-target="#inference">Inference</a>
  <ul class="collapse">
  <li><a href="#example-making-a-prediction" id="toc-example-making-a-prediction" class="nav-link" data-scroll-target="#example-making-a-prediction">Example: Making a Prediction</a></li>
  </ul></li>
  <li><a href="#whats-left" id="toc-whats-left" class="nav-link" data-scroll-target="#whats-left">Whats left?</a></li>
  <li><a href="#what-we-learned" id="toc-what-we-learned" class="nav-link" data-scroll-target="#what-we-learned">What we learned?</a>
  <ul class="collapse">
  <li><a href="#closing-thoughts" id="toc-closing-thoughts" class="nav-link" data-scroll-target="#closing-thoughts">Closing Thoughts</a></li>
  </ul></li>
  <li><a href="#about-the-pondering-guy-in-the-header" id="toc-about-the-pondering-guy-in-the-header" class="nav-link" data-scroll-target="#about-the-pondering-guy-in-the-header">About the pondering guy in the header</a></li>
  <li><a href="#citation" id="toc-citation" class="nav-link" data-scroll-target="#citation">Citation</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Bike Rentals Prediction API</h1>
</div>

<div>
  <div class="description">
    GitHub Repo: <a href="https://github.com/jospablo777/ml_model_api">Bike Rentals Prediction API</a>
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p><a href="https://www.linkedin.com/in/jose-barrantes/">Jose P. Barrantes</a> </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<p><img src="img/pondering_orb_meme.png" class="img-fluid"></p>
<section id="an-accesible-inference-system" class="level2">
<h2 class="anchored" data-anchor-id="an-accesible-inference-system">An accesible inference system</h2>
<p>In a fast-paced world, one of the problems we face as data professionals is delivering our data products promptly. Also, distributing them in a manner that doesn’t affect our productivity, for example, manually running a Jupyter Notebook or an R script every time someone needs insights, is awfully unproductive.</p>
<p>An idea that is not new, is to deliver the “answers” in an automated, from which the clients can self-serve each time they are in need. After we have a data product, for instance, a predictive model (<em>machine learning</em> if you are into buzzwords), we can make available its capabilities to our stakeholders via a micro service.</p>
<p>With that in mind, we will use this small tutorial to understand better the building of a production-ready machine learning microservice to predict bike rentals. By the end, you’ll have a solid understanding of using FastAPI for API development, Docker for containerization, and GitHub Actions for CI/CD. Whether you’re a data scientist looking to scale your models or a developer exploring microservices, this guide is for you.</p>
</section>
<section id="an-ml-model-as-a-microservice" class="level2">
<h2 class="anchored" data-anchor-id="an-ml-model-as-a-microservice">An ML model as a microservice</h2>
<p>Imagine your (predictive) model being accessed anytime without disturbing your peace or consuming your time; after all, your time is expensive, and you have many tasks. Here is where the idea of microservices comes into action. A microservice is an isolated piece of software that is in charge of a single task (service) and communicates through a well-defined API. You finish your model, pack it in a microservice, and make it available through an API.</p>
<p>This way, the model will always be available, and its consumption won’t block other tasks. Also, more products could be potentially developed with the API.</p>
</section>
<section id="but-what-is-an-api" class="level2">
<h2 class="anchored" data-anchor-id="but-what-is-an-api">But what is an API?</h2>
<p>An API is an intermediary that enables you to interact with a service without requiring knowledge of how this service works. You just need to know precisely what you want, tell it to the API, and the API will serve you what you requested.</p>
<p>Let’s say that after work, you get hungry, so you park your Capital Bikeshare™ bike out of your favorite Mexican restaurant<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. You enter the restaurant and sit at a table. Instead of going directly to the kitchen to cook your own meal or asking the chef what you want, you need to place your order through the waiter or waitress. You kindly request your enchiladas, and after a while, they bring your meal to you.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/restaurant_api.png" class="img-fluid figure-img"></p>
<figcaption>Allegory of a restaurant. The waiter/waitress is the API; the kitchen is the service (they are dedicated to cooking); you are the client</figcaption>
</figure>
</div>
<p>Notice that you, as the client, are not required to know how to cook enchiladas. Also, you do not interact directly with the people who prepare the food. You get what you want through a waiter (the API).</p>
<p>In summary, an API is the piece of the system you interact with to get a result generated by a service. Producing this result might be complex, but you don’t care about that since you only have to deal with the API.</p>
</section>
<section id="software-engineering-for-data-scientists" class="level2">
<h2 class="anchored" data-anchor-id="software-engineering-for-data-scientists">Software engineering for data scientists</h2>
<p>Another problem common to data scientists is that research, predictive modeling, and analytics are dirty processes. This is partly due to a lack of training in <strong>software engineering</strong>, which involves <strong>design</strong>, testing, and software maintenance.</p>
<p>We usually have many problems to solve, questions to answer, and limited time at work. This leaves little to no time to apply the best practices to develop our analysis and maintain our code, leaving a trail of technical debt with each delivery. Yet, since most of us write code, we are, in fact, software developers because we develop software. This should be a hard-to-miss hint that software engineering practices must be core in our profession, or at least not ignored.</p>
<p>Here, we will implement some practices core of software engineering like:</p>
<ul>
<li><strong>CI/CD:</strong> Continuous Integration (CI) and Continuous Deployment (CD) with GitHub Actions.</li>
<li><strong>Automated tests:</strong> unit, integration, and inference tests with <code>pytest</code>.</li>
<li><strong>Containerization:</strong> package the application with Docker for consistency across environments (i.e., it should work on every machine with a well-setup Docker). Dependency Management: For reproducibility, dependencies were specified in a <code>requirements.txt</code> file, and development was conducted in an isolated environment (<code>venv</code>).</li>
<li><strong>Microservices architecture:</strong> The project is a self-contained microservice focused on a single responsibility: predicting bike rentals. It is independently deployable and communicates through HTTP.</li>
</ul>
<p>We intend to review these concepts in a practical, applied way. This will give us more tools to design and produce more sustainable systems, which we can develop more efficiently through good practices without sacrificing smooth delivery to our clients.</p>
</section>
<section id="about-the-technologies" class="level2">
<h2 class="anchored" data-anchor-id="about-the-technologies">About the technologies</h2>
<p>Through this practical project, we will deal with several technologies, the most important:</p>
<ul>
<li><strong>FastAPI:</strong> a framework to develop APIs with Python. It is easy to learn, and it makes the development of APIs incredibly fast.</li>
<li><strong>Uvicorn:</strong> an ASGI (Asynchronous Server Getaway Interface) Server. It handles incoming HTTP requests and sends responses. This lightweight server is appropriate for our microservice.</li>
<li><strong>Docker:</strong> a platform to pack our application into isolated “containers” and make them available to be run in several systems. Perfect to build microservices.</li>
<li><strong>GitHub Actions:</strong> a CI/CD platform that allows us to automate your development pipelines. We will use them here to automate the software tests and build and push our docker images.</li>
<li><strong>pytest:</strong> a Python framework to simplify our software testing.</li>
</ul>
<p>These tools will make the development and publishing of our microservice a breeze.</p>
</section>
<section id="lets-get-started" class="level2">
<h2 class="anchored" data-anchor-id="lets-get-started">Let’s get started</h2>
<p>We will start with the mandatory xkcd comic that this kind of articles include so we can continue with the tutorial.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/exploits_of_a_mom.png" class="img-fluid figure-img"></p>
<figcaption>Exploits of a Mom, by xkcd Comics. Available at https://xkcd.com/3027/</figcaption>
</figure>
</div>
<p>I know that this has nothing to do with software engineering or APIs, but little Bobby Tables always cracks me laugh. Now we can continue with the build of our API and some software engineering practices.</p>
</section>
<section id="problem-we-want-to-solve" class="level2">
<h2 class="anchored" data-anchor-id="problem-we-want-to-solve">Problem we want to solve</h2>
<p>Now, let’s focus on the problem we want to solve; this is probably the most crucial step since it is how we <strong>add value</strong> to the business. We are hired to solve analytical problems with evidence (data) as our raw material to produce those solutions.</p>
<p>You probably won’t be surprised to learn this project started as a Jupyter Notebook, which I encourage you to <a href="https://github.com/jospablo777/ml_model_api/blob/main/notebooks/eda_and_toy_model.ipynb">check out here</a>. We are using an open data set from the <a href="https://archive.ics.uci.edu/dataset/275/bike+sharing+dataset">UCI Machine Learning Repository</a>.</p>
<p>Let’s assume we are working for <a href="https://capitalbikeshare.com/">Capital Bikeshare</a>, a company dedicated to providing a self-service bike rental service managed through a mobile app. For the company, it is crucial to predict the peaks of service usage so they can restock or make more available their products when they’re more needed. These products can be cloud computing resources during peak hours, bicycle units, human staff, etc. Also it can b convenient to predict the dates and hours of least use for maintenance tasks, like server updates or bike maintenance.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/Capital_Bikeshare_station_outside_Eastern_Market_Metro.jpg" class="img-fluid figure-img"></p>
<figcaption>Capital Bikeshare station outside of the Eastern Market Metro station. Author: Ben Schumin (2010). Licensed under CC BY-SA 3.0</figcaption>
</figure>
</div>
<p>Working as a data scientist for a big tech transport company, you will have lots of data and computational resources. On this occasion, you were put in charge of finding a way to predict the days and hours they will have to replenish their stock and increase the server’s capacity, investing in more resources only when necessary (saving money). Also, knowing when to schedule the maintenance labor will be valuable as well.</p>
<p>After finishing the data exploration, you know that working days and the entry and exit from work hours are the busiest time frames. Also, climatic conditions can affect the willingness to rent a bike. You are cautious, so you first took the time to understand the phenomenon. Then, you built the model prototype and corroborated that it is possible to forecast the number of rented bikes at an hour-of-the-day granularity level.</p>
<p>Success! You have a model that can help determine the best time to provide more resources or the times for maintenance. Does this mean that you have already finished with the task and can go on to live the good life?<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> Well, you already know that Jupyter is not a tool that produces clean results and that if you leave it there, your model will have to be run manually each time, which can introduce bugs and errors. This also means that you will have a high and constant influx of people knocking at your door<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> asking for predictions and insights.</p>
<p>Jupyter is ideal for experimenting and testing but not for delivering results. Hence, you have decided to deploy this first iteration of the model (the prototype) as a microservice that can be consumed via an API. Here, you can assess how the model behaves in the wild and prepare for future iterations. You will start adding value with predictions and valuable information that will help improve your model.</p>
<p>The engineering team, for example, will quickly adopt the app to know when to conduct maintenance jobs.</p>
</section>
<section id="microservice-development" class="level2">
<h2 class="anchored" data-anchor-id="microservice-development">Microservice development</h2>
<p>We were assigned a task, so we started by investigating bike rental data and then continued by building a predictive model using the <a href="https://catboost.ai/">CatBoost</a> algorithm. This model will be the inference engine of our microservice. You can see this part of the project <a href="https://github.com/jospablo777/ml_model_api/blob/main/notebooks/eda_and_toy_model.ipynb">here</a> in the notebook<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>. We saved the model in our project’s <code>predictive_models/</code> folder.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>During this tutorial, we will show you some code snippets and indicate the file where the code is located<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>. You should then be able to follow the project’s code, which is available on the <a href="https://github.com/jospablo777/ml_model_api">GitHub repo</a>.</p>
</div>
</div>
<p>After some research and experimentation, we developed a CatBoost model capable of predicting the number of rented bikes at a specific time, given some environmental and temporal conditions. The code that generated the model is next.</p>
<p>Filename: <a href="https://github.com/jospablo777/ml_model_api/blob/main/notebooks/eda_and_toy_model.ipynb"><code>notebooks/eda_and_toy_model.ipynb</code></a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> catboost <span class="im">import</span> CatBoostRegressor</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># --snip--</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Instantiate our model</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>catboost_model <span class="op">=</span> CatBoostRegressor(</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    iterations<span class="op">=</span><span class="dv">1000</span>,       <span class="co"># Boosting iterations</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    learning_rate<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    depth<span class="op">=</span><span class="dv">6</span>,               <span class="co"># Tree depth</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    loss_function<span class="op">=</span><span class="st">'RMSE'</span>,  <span class="co"># Loss</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="dv">100</span>            <span class="co"># Let it print the learning state every 100 iterations</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Train</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>catboost_model.fit(X_train, y_train, cat_features<span class="op">=</span>categorical_features)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># --snip--</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Save trained model</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>catboost_model.save_model(<span class="st">"../predictive_models/catboost_model_19Dec2024.cbm"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In <a href="https://github.com/jospablo777/ml_model_api/blob/main/notebooks/eda_and_toy_model.ipynb">this analysis</a>, we generated some insights<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> and the core of our microservice, a predictive model stored in <code>predictive_models/catboost_model_19Dec2024.cbm</code>. Now that we have our predictor, let’s see how we can make the predictions accessible to others in the company.</p>
</section>
<section id="api-development" class="level2">
<h2 class="anchored" data-anchor-id="api-development">API development</h2>
<p>The API will move data around (receive and deliver) as its primary job, so it is key to establish a clear set of rules for the data our clients send. Moving back to our restaurant example, you probably could put your enchiladas order in English or Spanish, but it might be hard for the waiter if you place the order in Japanese<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>. Hence, to get your enchiladas, you must request them in a way that the staff can understand, and <a href="https://docs.pydantic.dev/latest/">Pydantic</a> is here to enforce the rules that make such understanding happen.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/restaurant_api_jap.png" class="img-fluid figure-img"></p>
<figcaption>An ambiguous (and invalid) request request to the API, so no enchiladas :(</figcaption>
</figure>
</div>
<section id="defining-the-pydantic-model" class="level3">
<h3 class="anchored" data-anchor-id="defining-the-pydantic-model">Defining the Pydantic model</h3>
<p>We will start this section by defining our Pydantic model. Pydantic is a library for data validation that uses Python-type annotations. Let’s establish a Pydantic model for our API requests and learn more about the library in the process.</p>
<p>Filename: <a href="https://github.com/jospablo777/ml_model_api/blob/main/app/models/bike_sharing.py"><code>app/models/bike_sharing.py</code></a></p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-2"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-2-1"><a href="#annotated-cell-2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pydantic <span class="im">import</span> BaseModel, Field, field_validator</span>
<span id="annotated-cell-2-2"><a href="#annotated-cell-2-2" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-2-3" class="code-annotation-target"><a href="#annotated-cell-2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BikeSharingRequest(BaseModel):</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-2-4" class="code-annotation-target"><a href="#annotated-cell-2-4" aria-hidden="true" tabindex="-1"></a>    season: <span class="bu">str</span> <span class="op">=</span> Field(..., description<span class="op">=</span><span class="st">"Season (Winter/Spring/Summer/Fall)"</span>)</span>
<span id="annotated-cell-2-5"><a href="#annotated-cell-2-5" aria-hidden="true" tabindex="-1"></a>    mnth: <span class="bu">str</span> <span class="op">=</span> Field(..., description<span class="op">=</span><span class="st">"Month name (January, etc.)"</span>)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-2-6" class="code-annotation-target"><a href="#annotated-cell-2-6" aria-hidden="true" tabindex="-1"></a>    hr: <span class="bu">int</span> <span class="op">=</span> Field(..., ge<span class="op">=</span><span class="dv">0</span>, le<span class="op">=</span><span class="dv">23</span>, description<span class="op">=</span><span class="st">"Hour of the day"</span>)</span>
<span id="annotated-cell-2-7"><a href="#annotated-cell-2-7" aria-hidden="true" tabindex="-1"></a>    holiday: <span class="bu">str</span> <span class="op">=</span> Field(..., description<span class="op">=</span><span class="st">"Yes/No if holiday"</span>)</span>
<span id="annotated-cell-2-8"><a href="#annotated-cell-2-8" aria-hidden="true" tabindex="-1"></a>    weekday: <span class="bu">str</span> <span class="op">=</span> Field(..., description<span class="op">=</span><span class="st">"Name of the weekday (Monday/Tuesday/Wednesday/Thursday/Friday/Saturday/Sunday)"</span>)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-2-9" class="code-annotation-target"><a href="#annotated-cell-2-9" aria-hidden="true" tabindex="-1"></a>    workingday: <span class="bu">str</span> <span class="op">=</span> Field(..., description<span class="op">=</span><span class="st">"Yes/No if working day"</span>)</span>
<span id="annotated-cell-2-10"><a href="#annotated-cell-2-10" aria-hidden="true" tabindex="-1"></a>    weathersit: <span class="bu">int</span> <span class="op">=</span> Field(..., description<span class="op">=</span><span class="st">"Weather code"</span>)</span>
<span id="annotated-cell-2-11"><a href="#annotated-cell-2-11" aria-hidden="true" tabindex="-1"></a>    temp: <span class="bu">float</span> <span class="op">=</span> Field(..., ge<span class="op">=</span><span class="dv">0</span>, le<span class="op">=</span><span class="dv">1</span>, description<span class="op">=</span><span class="st">"Normalized temperature"</span>)</span>
<span id="annotated-cell-2-12"><a href="#annotated-cell-2-12" aria-hidden="true" tabindex="-1"></a>    atemp: <span class="bu">float</span> <span class="op">=</span> Field(..., ge<span class="op">=</span><span class="dv">0</span>, le<span class="op">=</span><span class="dv">1</span>, description<span class="op">=</span><span class="st">"Normalized feeling temperature"</span>)</span>
<span id="annotated-cell-2-13"><a href="#annotated-cell-2-13" aria-hidden="true" tabindex="-1"></a>    hum: <span class="bu">float</span> <span class="op">=</span> Field(..., ge<span class="op">=</span><span class="dv">0</span>, le<span class="op">=</span><span class="dv">1</span>, description<span class="op">=</span><span class="st">"Normalized humidity"</span>)</span>
<span id="annotated-cell-2-14"><a href="#annotated-cell-2-14" aria-hidden="true" tabindex="-1"></a>    windspeed: <span class="bu">float</span> <span class="op">=</span> Field(..., ge<span class="op">=</span><span class="dv">0</span>, le<span class="op">=</span><span class="dv">1</span>, description<span class="op">=</span><span class="st">"Normalized wind speed"</span>)</span>
<span id="annotated-cell-2-15"><a href="#annotated-cell-2-15" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-2-16" class="code-annotation-target"><a href="#annotated-cell-2-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">@field_validator</span>(<span class="st">"season"</span>)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-2-17" class="code-annotation-target"><a href="#annotated-cell-2-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> validate_season(cls, v):</span>
<span id="annotated-cell-2-18"><a href="#annotated-cell-2-18" aria-hidden="true" tabindex="-1"></a>        allowed <span class="op">=</span> {<span class="st">"Winter"</span>, <span class="st">"Spring"</span>, <span class="st">"Summer"</span>, <span class="st">"Fall"</span>} </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="7" onclick="event.preventDefault();">7</a><span id="annotated-cell-2-19" class="code-annotation-target"><a href="#annotated-cell-2-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> v <span class="kw">not</span> <span class="kw">in</span> allowed:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="8" onclick="event.preventDefault();">8</a><span id="annotated-cell-2-20" class="code-annotation-target"><a href="#annotated-cell-2-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"season must be one of </span><span class="sc">{</span>allowed<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="annotated-cell-2-21"><a href="#annotated-cell-2-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> v</span>
<span id="annotated-cell-2-22"><a href="#annotated-cell-2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-2-23"><a href="#annotated-cell-2-23" aria-hidden="true" tabindex="-1"></a><span class="co"># -- snip -- (validators continue)</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-2" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="3" data-code-annotation="1">The first thing to notice is that the Pydantic model is defined as a Python class that inherits from <code>BaseModel</code>; this is the Pydantic base class used to create models with built-in data validation.</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="4" data-code-annotation="2">Each class attribute is defined with a data type; <code>season</code>, for example, is defined as <code>str</code>. We also use the function <code>Field()</code> to specify constraints and metadata; the ellipsis literal <code>...</code> here means two things: first, a value must be provided, second, there is no default value for this attribute. Then, some metadata is specified in the <code>description</code> parameter.</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="6" data-code-annotation="3">For <code>hr</code> attribute, we have constraints used for numeric validation. So, <code>ge=0</code> means that the hour has to be greater or equal to 0, while <code>le=23</code> indicates that the hour should be less or equal to 23. So if the user send a request with <code>hr=-1</code> the system will complain and throw a warning.</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="9" data-code-annotation="4">With what we know so far, we could read this line as “<code>workingday</code> is a required <code>str</code> field with a description.”</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="16" data-code-annotation="5">We have the <code>field_validator</code> decorator<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a> to build custom validation logic for a specific field. Besides the already fantastic default capabilities of Pydantic, we can define our custom validations. In this case, we want to be sure that the client will provide only valid values for the <code>season</code> field. CatBoost uses categories as predictors, and it is case sensitive (i.e., <code>"Summer" != "summer</code>). With this extra step, FastAPI will send a custom message to the client, informing that the API expects <code>"Summer"</code> not <code>"summer"</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="17" data-code-annotation="6">We define the function <code>validate_season</code>, which takes two parameters: <code>cls</code>, a keyword indicating a reference to the class (<code>BikeSharingRequest</code>), and <code>v</code>, representing the value of the field we’re validating.</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="19" data-code-annotation="7">Check if the value we validate is within the <code>allowed</code> set.</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="20" data-code-annotation="8">Raise an error if the value is not allowed; it also tells the client which values are expected.</span>
</dd>
</dl>
</div>
</div>
<p>To summarize the structure of our Pydantic model:</p>
<p>Filename: <a href="https://github.com/jospablo777/ml_model_api/blob/main/app/models/bike_sharing.py"><code>app/models/bike_sharing.py</code></a></p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-3"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-3-1" class="code-annotation-target"><a href="#annotated-cell-3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pydantic <span class="im">import</span> BaseModel, Field, field_validator</span>
<span id="annotated-cell-3-2"><a href="#annotated-cell-3-2" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-3-3" class="code-annotation-target"><a href="#annotated-cell-3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BikeSharingRequest(BaseModel):</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-3-4" class="code-annotation-target"><a href="#annotated-cell-3-4" aria-hidden="true" tabindex="-1"></a>    season: <span class="bu">str</span> <span class="op">=</span> Field(..., description<span class="op">=</span><span class="st">"Season (Winter/Spring/Summer/Fall)"</span>)</span>
<span id="annotated-cell-3-5"><a href="#annotated-cell-3-5" aria-hidden="true" tabindex="-1"></a>    mnth: <span class="bu">str</span> <span class="op">=</span> Field(..., description<span class="op">=</span><span class="st">"Month name (January, etc.)"</span>)</span>
<span id="annotated-cell-3-6"><a href="#annotated-cell-3-6" aria-hidden="true" tabindex="-1"></a>    hr: <span class="bu">int</span> <span class="op">=</span> Field(..., ge<span class="op">=</span><span class="dv">0</span>, le<span class="op">=</span><span class="dv">23</span>, description<span class="op">=</span><span class="st">"Hour of the day"</span>)</span>
<span id="annotated-cell-3-7"><a href="#annotated-cell-3-7" aria-hidden="true" tabindex="-1"></a>    holiday: <span class="bu">str</span> <span class="op">=</span> Field(..., description<span class="op">=</span><span class="st">"Yes/No if holiday"</span>)</span>
<span id="annotated-cell-3-8"><a href="#annotated-cell-3-8" aria-hidden="true" tabindex="-1"></a>    weekday: <span class="bu">str</span> <span class="op">=</span> Field(..., description<span class="op">=</span><span class="st">"Name of the weekday (Monday/Tuesday/Wednesday/Thursday/Friday/Saturday/Sunday)"</span>)</span>
<span id="annotated-cell-3-9"><a href="#annotated-cell-3-9" aria-hidden="true" tabindex="-1"></a>    workingday: <span class="bu">str</span> <span class="op">=</span> Field(..., description<span class="op">=</span><span class="st">"Yes/No if working day"</span>)</span>
<span id="annotated-cell-3-10"><a href="#annotated-cell-3-10" aria-hidden="true" tabindex="-1"></a>    weathersit: <span class="bu">int</span> <span class="op">=</span> Field(..., description<span class="op">=</span><span class="st">"Weather code"</span>)</span>
<span id="annotated-cell-3-11"><a href="#annotated-cell-3-11" aria-hidden="true" tabindex="-1"></a>    temp: <span class="bu">float</span> <span class="op">=</span> Field(..., ge<span class="op">=</span><span class="dv">0</span>, le<span class="op">=</span><span class="dv">1</span>, description<span class="op">=</span><span class="st">"Normalized temperature"</span>)</span>
<span id="annotated-cell-3-12"><a href="#annotated-cell-3-12" aria-hidden="true" tabindex="-1"></a>    atemp: <span class="bu">float</span> <span class="op">=</span> Field(..., ge<span class="op">=</span><span class="dv">0</span>, le<span class="op">=</span><span class="dv">1</span>, description<span class="op">=</span><span class="st">"Normalized feeling temperature"</span>)</span>
<span id="annotated-cell-3-13"><a href="#annotated-cell-3-13" aria-hidden="true" tabindex="-1"></a>    hum: <span class="bu">float</span> <span class="op">=</span> Field(..., ge<span class="op">=</span><span class="dv">0</span>, le<span class="op">=</span><span class="dv">1</span>, description<span class="op">=</span><span class="st">"Normalized humidity"</span>)</span>
<span id="annotated-cell-3-14"><a href="#annotated-cell-3-14" aria-hidden="true" tabindex="-1"></a>    windspeed: <span class="bu">float</span> <span class="op">=</span> Field(..., ge<span class="op">=</span><span class="dv">0</span>, le<span class="op">=</span><span class="dv">1</span>, description<span class="op">=</span><span class="st">"Normalized wind speed"</span>)</span>
<span id="annotated-cell-3-15"><a href="#annotated-cell-3-15" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-3-16" class="code-annotation-target"><a href="#annotated-cell-3-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">@field_validator</span>(<span class="st">"season"</span>)</span>
<span id="annotated-cell-3-17"><a href="#annotated-cell-3-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> validate_season(cls, v):</span>
<span id="annotated-cell-3-18"><a href="#annotated-cell-3-18" aria-hidden="true" tabindex="-1"></a>        allowed <span class="op">=</span> {<span class="st">"Winter"</span>, <span class="st">"Spring"</span>, <span class="st">"Summer"</span>, <span class="st">"Fall"</span>}</span>
<span id="annotated-cell-3-19"><a href="#annotated-cell-3-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> v <span class="kw">not</span> <span class="kw">in</span> allowed:</span>
<span id="annotated-cell-3-20"><a href="#annotated-cell-3-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"season must be one of </span><span class="sc">{</span>allowed<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="annotated-cell-3-21"><a href="#annotated-cell-3-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> v</span>
<span id="annotated-cell-3-22"><a href="#annotated-cell-3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-23"><a href="#annotated-cell-3-23" aria-hidden="true" tabindex="-1"></a><span class="co"># -- snip -- (validators continue)</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-3" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="1" data-code-annotation="1">Required Pydantic imports.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="3" data-code-annotation="2">The model is defined as a Python class.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="4,5,6,7,8,9,10,11,12,13,14" data-code-annotation="3">Within the class, we define the model’s fields as attributes of the class</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="16,17,18,19,20,21" data-code-annotation="4">We can include custom validators within the model.</span>
</dd>
</dl>
</div>
</div>
<p>Great! Now, we have a Pydantic model and a better understanding of it. Next, we will work on our API.</p>
</section>
<section id="fastapi-development" class="level3">
<h3 class="anchored" data-anchor-id="fastapi-development">FastAPI development</h3>
<p>With the data model in place (BikeSharingRequest), it’s time to develop the core of our FastAPI microservice. FastAPI makes it easy to build performant APIs with built-in data validation and clear, concise code. In this section, we’ll walk through setting up the app, creating endpoints, and serving a machine learning model for predictions.</p>
<p>To get started with our FastAPI app, we create the Python file <code>app/main.py</code>. Let’s take a look at the imports we’re gonna need.</p>
<p>Filename: <a href="https://github.com/jospablo777/ml_model_api/blob/main/app/main.py"><code>app/main.py</code></a></p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-4"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-4-1"><a href="#annotated-cell-4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastapi <span class="im">import</span> FastAPI</span>
<span id="annotated-cell-4-2"><a href="#annotated-cell-4-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List</span>
<span id="annotated-cell-4-3"><a href="#annotated-cell-4-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app.services.ml_model <span class="im">import</span> load_model</span>
<span id="annotated-cell-4-4"><a href="#annotated-cell-4-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app.services.requests_to_polars <span class="im">import</span> req_to_polars</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-4-5" class="code-annotation-target"><a href="#annotated-cell-4-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app.models.bike_sharing <span class="im">import</span> BikeSharingRequest</span>
<span id="annotated-cell-4-6"><a href="#annotated-cell-4-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastapi <span class="im">import</span> HTTPException</span>
<span id="annotated-cell-4-7"><a href="#annotated-cell-4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-4-8"><a href="#annotated-cell-4-8" aria-hidden="true" tabindex="-1"></a><span class="co"># --snip--</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-4" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="5" data-code-annotation="1">In this line we import the Pydantic data model we created in the previous step.</span>
</dd>
</dl>
</div>
</div>
<p>Next, we will begin coding the core of our FastAPI app, starting with the instantiation of the main application object, <code>app</code>. This is done using the <code>FastAPI()</code> constructor. The annotated code is shown below.</p>
<p>Filename: <a href="https://github.com/jospablo777/ml_model_api/blob/main/app/main.py"><code>app/main.py</code></a></p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-5"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-5-1"><a href="#annotated-cell-5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># -- snip --</span></span>
<span id="annotated-cell-5-2"><a href="#annotated-cell-5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-5-3"><a href="#annotated-cell-5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Instantiate a FastAPI class, the core of the application</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-5-4" class="code-annotation-target"><a href="#annotated-cell-5-4" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> FastAPI()</span>
<span id="annotated-cell-5-5"><a href="#annotated-cell-5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-5-6"><a href="#annotated-cell-5-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Read predictive model</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-5-7" class="code-annotation-target"><a href="#annotated-cell-5-7" aria-hidden="true" tabindex="-1"></a>ml_model <span class="op">=</span> load_model(<span class="st">'predictive_models/catboost_model_19Dec2024.cbm'</span>)</span>
<span id="annotated-cell-5-8"><a href="#annotated-cell-5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-5-9"><a href="#annotated-cell-5-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Defines a GET endpoin at the root path "/"</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-5-10" class="code-annotation-target"><a href="#annotated-cell-5-10" aria-hidden="true" tabindex="-1"></a><span class="at">@app.get</span>(<span class="st">"/"</span>)</span>
<span id="annotated-cell-5-11"><a href="#annotated-cell-5-11" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> index() <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="annotated-cell-5-12"><a href="#annotated-cell-5-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">"message"</span>: <span class="st">"Bike rentals ML predictor (regressor)"</span>} <span class="co"># Returns a simple JSON response with a message</span></span>
<span id="annotated-cell-5-13"><a href="#annotated-cell-5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-5-14"><a href="#annotated-cell-5-14" aria-hidden="true" tabindex="-1"></a><span class="co"># --snip--</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-5" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="4" data-code-annotation="1">Instantiates the main FastAPI application. Every endpoint and configuration will attach to this <code>app</code> object.</span>
</dd>
<dt data-target-cell="annotated-cell-5" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="7" data-code-annotation="2">Read the predictive model, which is a trained CatBoost model.</span>
</dd>
<dt data-target-cell="annotated-cell-5" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="10" data-code-annotation="3">A GET endpoint to the root URL. When someone accesses this endpoint, they will be served with the “message.”</span>
</dd>
</dl>
</div>
</div>
<p>So far, we have instantiated the FastAPI application and defined the root endpoint. Next, we’ll implement the core functionality of our app by defining the <code>/predict</code> endpoint. This endpoint serves as the heart of the API, handling four key responsibilities:</p>
<ol type="1">
<li><strong>Validation:</strong> Ensures the incoming requests meet the expected format and constraints.</li>
<li><strong>Data Processing:</strong> Transforms input data into a format compatible with the trained CatBoost model.</li>
<li><strong>Prediction:</strong> Uses the model to generate predictions based on the input.</li>
<li><strong>Response Generation:</strong> Packages the predictions into a JSON response to return to the client.</li>
</ol>
<section id="defining-the-predict-endpoint" class="level4">
<h4 class="anchored" data-anchor-id="defining-the-predict-endpoint">Defining the <code>/predict</code> Endpoint</h4>
<p>In this step, we define the core functionality of our API: the /predict endpoint. This endpoint handles incoming POST requests, validates the input data, processes it, generates predictions using the trained CatBoost model, and returns the predictions as a JSON response.</p>
<p>Let’s see the code.</p>
<p>Filename: <a href="https://github.com/jospablo777/ml_model_api/blob/main/app/main.py"><code>app/main.py</code></a></p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-6"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-6-1"><a href="#annotated-cell-6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># -- snip --</span></span>
<span id="annotated-cell-6-2"><a href="#annotated-cell-6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-6-3"><a href="#annotated-cell-6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Defines a POST endpoint for predictions</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-6-4" class="code-annotation-target"><a href="#annotated-cell-6-4" aria-hidden="true" tabindex="-1"></a><span class="at">@app.post</span>(<span class="st">'/predict'</span>,</span>
<span id="annotated-cell-6-5"><a href="#annotated-cell-6-5" aria-hidden="true" tabindex="-1"></a>          summary <span class="op">=</span> <span class="st">"Predict bike rentals"</span>,</span>
<span id="annotated-cell-6-6"><a href="#annotated-cell-6-6" aria-hidden="true" tabindex="-1"></a>          description <span class="op">=</span> <span class="st">"Takes input data and returns amount rental predictions (regression)."</span>)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-6-7" class="code-annotation-target"><a href="#annotated-cell-6-7" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> predict_rentals(requests: List[BikeSharingRequest]) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="annotated-cell-6-8"><a href="#annotated-cell-6-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="annotated-cell-6-9"><a href="#annotated-cell-6-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Predict bike rentals based on input features.</span></span>
<span id="annotated-cell-6-10"><a href="#annotated-cell-6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-6-11"><a href="#annotated-cell-6-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="annotated-cell-6-12"><a href="#annotated-cell-6-12" aria-hidden="true" tabindex="-1"></a><span class="co">        requests (List[BikeSharingRequests]): A list of input data objects.</span></span>
<span id="annotated-cell-6-13"><a href="#annotated-cell-6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-6-14"><a href="#annotated-cell-6-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="annotated-cell-6-15"><a href="#annotated-cell-6-15" aria-hidden="true" tabindex="-1"></a><span class="co">        dict: A dictionary containing the predictions as a list.</span></span>
<span id="annotated-cell-6-16"><a href="#annotated-cell-6-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="annotated-cell-6-17"><a href="#annotated-cell-6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-6-18"><a href="#annotated-cell-6-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handles the case when an empty list is posted</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-6-19" class="code-annotation-target"><a href="#annotated-cell-6-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> requests:</span>
<span id="annotated-cell-6-20"><a href="#annotated-cell-6-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> HTTPException(</span>
<span id="annotated-cell-6-21"><a href="#annotated-cell-6-21" aria-hidden="true" tabindex="-1"></a>            status_code <span class="op">=</span> <span class="dv">422</span>,</span>
<span id="annotated-cell-6-22"><a href="#annotated-cell-6-22" aria-hidden="true" tabindex="-1"></a>            detail <span class="op">=</span> <span class="st">"The request is empty"</span></span>
<span id="annotated-cell-6-23"><a href="#annotated-cell-6-23" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="annotated-cell-6-24"><a href="#annotated-cell-6-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="annotated-cell-6-25"><a href="#annotated-cell-6-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert each pydantic model to a dict and load into a Polars DataFrame</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-6-26" class="code-annotation-target"><a href="#annotated-cell-6-26" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> req_to_polars(requests)</span>
<span id="annotated-cell-6-27"><a href="#annotated-cell-6-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-6-28"><a href="#annotated-cell-6-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Instances to predict</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-6-29" class="code-annotation-target"><a href="#annotated-cell-6-29" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> df.to_numpy()</span>
<span id="annotated-cell-6-30"><a href="#annotated-cell-6-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-6-31"><a href="#annotated-cell-6-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make predictions</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-6-32" class="code-annotation-target"><a href="#annotated-cell-6-32" aria-hidden="true" tabindex="-1"></a>    predictions <span class="op">=</span> ml_model.predict(features)</span>
<span id="annotated-cell-6-33"><a href="#annotated-cell-6-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-6-34"><a href="#annotated-cell-6-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="7" onclick="event.preventDefault();">7</a><span id="annotated-cell-6-35" class="code-annotation-target"><a href="#annotated-cell-6-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">'predictions'</span>: predictions.tolist()</span>
<span id="annotated-cell-6-36"><a href="#annotated-cell-6-36" aria-hidden="true" tabindex="-1"></a>    }</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-6" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="4,5,6" data-code-annotation="1"><strong><code>POST</code> Endpoint Definition:</strong> Defines a <code>POST</code> endpoint at <code>/predict</code> with metadata for better documentation (<code>summary</code> and <code>description</code>).</span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="7" data-code-annotation="2"><strong>Input Validation:</strong> Expects a list of <code>BikeSharingRequest</code> objects, ensuring automatic data validation by FastAPI.</span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="19,20,21,22,23" data-code-annotation="3"><strong>Empty Request Handling:</strong> If the request body is empty (<code>[]</code>), returns a <code>422 Unprocessable Entity</code> error with a descriptive message.</span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="26" data-code-annotation="4"><strong>Data Transformation:</strong> Converts the list of validated Pydantic objects into a Polars DataFrame for efficient processing.</span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="29" data-code-annotation="5"><strong>Compatibility with CatBoost:</strong> Since CatBoost does not accept Polars DataFrames, the data is converted to a NumPy array.</span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="32" data-code-annotation="6"><strong>Predictions:</strong> Uses the trained CatBoost model to compute predictions based on the input data.</span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="35" data-code-annotation="7"><strong>Response Creation:</strong> Returns the predictions as a JSON-compatible dictionary.</span>
</dd>
</dl>
</div>
</div>
</section>
<section id="endpoint-responsibilities" class="level4">
<h4 class="anchored" data-anchor-id="endpoint-responsibilities">Endpoint Responsibilities</h4>
<p>The <code>predict_rentals</code> function handles multiple responsibilities:</p>
<ul>
<li><strong>Edge Case Handling:</strong> Validates and handles empty input.</li>
<li><strong>Data Transformation:</strong> Converts structured input data into a format compatible with the machine learning model (numpy).</li>
<li><strong>Inference:</strong> Generates predictions using the trained CatBoost model.</li>
<li><strong>Response Generation:</strong> Packages the results into a JSON response.</li>
</ul>
</section>
<section id="testing-the-application" class="level4">
<h4 class="anchored" data-anchor-id="testing-the-application">Testing the Application</h4>
<p>With the ‘/predict’ endpoint defined, we now have the core functionality of our prediction API. Let’s test it!</p>
<section id="clone-the-repository" class="level5">
<h5 class="anchored" data-anchor-id="clone-the-repository">Clone the Repository</h5>
<p>If you haven’t already, clone the GitHub repository to follow along.</p>
</section>
<section id="run-the-application" class="level5">
<h5 class="anchored" data-anchor-id="run-the-application">Run the Application</h5>
<p>From the root of the project, start the FastAPI app using Uvicorn:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">uvicorn</span> app.main:app <span class="at">--host</span> 127.0.0.1 <span class="at">--port</span> 8000</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once the application is running, you should see output similar to this in your terminal:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">user@user-pc:~/ml_model_api$</span> uvicorn app.main:app</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ex">INFO:</span>     Started server process <span class="pp">[</span><span class="ss">19168</span><span class="pp">]</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="ex">INFO:</span>     Waiting for application startup.</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="ex">INFO:</span>     Application startup complete.</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="ex">INFO:</span>     Uvicorn running on http://127.0.0.1:8000 <span class="er">(</span><span class="ex">Press</span> CTRL+C to quit<span class="kw">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="explore-the-api" class="level4">
<h4 class="anchored" data-anchor-id="explore-the-api">Explore the API</h4>
<p>With the app running, you can now access the API:</p>
<ul>
<li>API Root: <a href="http://127.0.0.1:8000/">http://127.0.0.1:8000/</a></li>
</ul>
<p>When you visit the root endpoint, you’ll see the following message:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"message"</span><span class="fu">:</span> <span class="st">"Bike rentals ML predictor (regressor)"</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="pydantic-model" class="level3">
<h3 class="anchored" data-anchor-id="pydantic-model">Pydantic model</h3>
<p>One of the standout features of FastAPI is its ability to automatically generate API documentation, complete with interactive functionality. You can access the API documentation for this project by visiting:</p>
<ul>
<li>Swagger UI (API Documentation): <a href="http://127.0.0.1:8000/docs">http://127.0.0.1:8000/docs</a></li>
</ul>
<p>In this interface, you can:</p>
<ol type="1">
<li>Explore the API’s endpoints and their specifications.</li>
<li>Test the endpoints directly using the provided interface.</li>
<li>Examine the Pydantic model used for data validation.</li>
</ol>
<section id="exploring-the-pydantic-model" class="level4">
<h4 class="anchored" data-anchor-id="exploring-the-pydantic-model">Exploring the Pydantic Model</h4>
<p>FastAPI uses Pydantic under the hood to validate and parse incoming JSON data. If you navigate to the Swagger UI, you’ll find the schema for the <code>BikeSharingRequest</code> model. This schema provides key information:</p>
<ul>
<li><strong>Field Descriptions:</strong> Attributes in the BikeSharingRequest class are documented, including the description parameter provided via Field().</li>
<li><strong>Data Type Constraints:</strong> Default type constraints (e.g., string, integer) are visible for each field.</li>
<li><strong>Range Restrictions:</strong> For numeric fields, restrictions such as [0, 23] for the hr field are displayed clearly in square brackets.</li>
</ul>
</section>
<section id="custom-validators" class="level4">
<h4 class="anchored" data-anchor-id="custom-validators">Custom Validators</h4>
<p>While custom validators are not automatically displayed in the Swagger UI, their logic is included (manually) as metadata in the <code>description</code> of the corresponding fields. For instance, you can view notes about specific constraints or requirements that are enforced programmatically.</p>
<p>FastAPI ensures each JSON object in the incoming list is validated and parsed into a <code>BikeSharingRequest</code> instance using Pydantic. This guarantees data consistency and simplifies further processing.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/schema_pydantic_model.png" class="img-fluid figure-img"></p>
<figcaption>Swagger UI. The Pydantic model for <code>BikeSharingRequest</code> is expanded in the Schemas section</figcaption>
</figure>
</div>
</section>
</section>
<section id="fastapi-app" class="level3">
<h3 class="anchored" data-anchor-id="fastapi-app">FastAPI app</h3>
<p>The FastAPI process begins when a user sends a <code>POST</code> request containing input data in JSON format. FastAPI inspects the request body and knows to parse it as a <code>List[BikeSharingRequest]</code> object. FastAPI knows how to parse the JSON due to the endpoint function signature:</p>
<p>Filename: <a href="https://github.com/jospablo777/ml_model_api/blob/main/app/main.py"><code>app/main.py</code></a></p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-10"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-10-1"><a href="#annotated-cell-10-1" aria-hidden="true" tabindex="-1"></a><span class="at">@app.post</span>(<span class="st">'/predict'</span>, </span>
<span id="annotated-cell-10-2"><a href="#annotated-cell-10-2" aria-hidden="true" tabindex="-1"></a>          summary <span class="op">=</span> <span class="st">"Predict bike rentals"</span>, </span>
<span id="annotated-cell-10-3"><a href="#annotated-cell-10-3" aria-hidden="true" tabindex="-1"></a>          description <span class="op">=</span> <span class="st">"Takes input data and returns amount rental predictions (regression)."</span>)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-10-4" class="code-annotation-target"><a href="#annotated-cell-10-4" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> predict_rentals(requests: List[BikeSharingRequest]) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-10" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="4" data-code-annotation="1">In the function signature, the <code>List[BikeSharingRequest]</code> annotation informs FastAPI to interpret the raw JSON input as a list of JSON objects that match the <code>BikeSharingRequest</code> schema.</span>
</dd>
</dl>
</div>
</div>
<section id="process-breakdown" class="level4">
<h4 class="anchored" data-anchor-id="process-breakdown">Process Breakdown</h4>
<section id="json-parsing-and-validation" class="level5">
<h5 class="anchored" data-anchor-id="json-parsing-and-validation">1. JSON Parsing and Validation</h5>
<ul>
<li>FastAPI loops through the JSON objects in the request body.</li>
<li>Each JSON object is validated against the <code>BikeSharingRequest</code> Pydantic model.</li>
<li>Validation includes:
<ul>
<li>Ensuring all required fields are present.</li>
<li>Verifying field types and constraints.</li>
<li>Applying custom validators defined in the <code>BikeSharingRequest</code> model.</li>
</ul></li>
</ul>
</section>
<section id="error-handling" class="level5">
<h5 class="anchored" data-anchor-id="error-handling">2. Error Handling</h5>
<ul>
<li>If any JSON object fails validation, FastAPI stops the process and returns a <code>422 Unprocessable Entity</code> response, including details about the validation errors.</li>
<li>The <code>predict_rentals</code> function is not called if validation fails.</li>
</ul>
</section>
<section id="object-creation" class="level5">
<h5 class="anchored" data-anchor-id="object-creation">3. Object Creation</h5>
<ul>
<li>If all JSON objects pass validation, FastAPI creates a list of <code>BikeSharingRequest</code> instances and passes them to the <code>predict_rentals</code> function as the <code>requests</code> argument.</li>
</ul>
</section>
<section id="data-shaping-and-inference" class="level5">
<h5 class="anchored" data-anchor-id="data-shaping-and-inference">4. Data Shaping and Inference</h5>
<ul>
<li>Inside the <code>predict_rentals</code> function:
<ul>
<li>The input data is shaped for inference by the CatBoost model.</li>
<li>From <code>List(BikeSharingRequest)</code> to numpy array.</li>
<li>Predictions are generated using the trained model.</li>
</ul></li>
</ul>
</section>
<section id="response" class="level5">
<h5 class="anchored" data-anchor-id="response">5. Response</h5>
<ul>
<li>The predictions are formatted as a JSON response and sent back to the user.</li>
</ul>
</section>
</section>
<section id="visual-representation" class="level4">
<h4 class="anchored" data-anchor-id="visual-representation">Visual Representation</h4>
<p>The entire process is summarized in the flowchart below:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/fastapi_app_flowchart.png" class="img-fluid figure-img"></p>
<figcaption>Visual representation of our FastAPI app</figcaption>
</figure>
</div>
<p>For simplicity, the Uvicorn server is abstracted away from the diagram. The focus is solely on the core FastAPI application flow, from receiving a request to sending a response.</p>
<p>With the core functionality of our FastAPI application in place, (i.e., the `/predict/predict endpoint for serving predictions), it’s time to focus on deployment and automation. While building a robust application is essential, ensuring that it can be reliably tested, built, and deployed is equally important. This is where Continuous Integration (CI) and Continuous Deployment (CD) come into play.</p>
<section id="by-implementing-cicd-pipelines-we-can" class="level5">
<h5 class="anchored" data-anchor-id="by-implementing-cicd-pipelines-we-can">By implementing CI/CD pipelines, we can:</h5>
<ol type="1">
<li><strong>Automate Testing:</strong> Ensure every change to the codebase is verified by running unit tests and integration tests automatically.</li>
<li><strong>Streamline Deployment:</strong> Build and push a Docker image of the application to a container registry (e.g., Docker Hub), ready for deployment in any environment.</li>
<li><strong>Maintain Code Quality:</strong> Catch bugs early and enforce consistent standards with every change.</li>
</ol>
<p>In the next section, we’ll set up a CI/CD workflow using GitHub Actions to:</p>
<ul>
<li>Run automated tests with pytest.</li>
<li>Build and publish a Docker image of our FastAPI app.</li>
<li>Let’s dive into automating the lifecycle of our application!</li>
</ul>
</section>
</section>
</section>
</section>
<section id="cicd-continuous-integration-continuos-deployment" class="level2">
<h2 class="anchored" data-anchor-id="cicd-continuous-integration-continuos-deployment">CI/CD (Continuous Integration / Continuos Deployment)</h2>
<p>Continuous Integration (CI) and Continuous Deployment (CD) are essential pillars of modern software development, enabling teams to automate testing, building, and deployment processes. They ensure that every change to the codebase is rigorously tested and deployed efficiently.</p>
<p>While I’d love to provide an in-depth introduction to CI/CD here, I highly recommend the excellent tutorial by <a href="https://itskmyoo.medium.com/">Itskmyoo</a>, titled <a href="https://itskmyoo.medium.com/automating-fastapi-project-build-with-github-actions-and-push-to-dockerhub-b4c6df319b2a">Automating FastAPI Project Build with GitHub Actions and Push to DockerHub</a>. It offers a clear, practical guide to setting up CI/CD pipelines for FastAPI projects using GitHub Actions.</p>
<section id="our-customization" class="level3">
<h3 class="anchored" data-anchor-id="our-customization">Our Customization</h3>
<p>Building on <a href="https://itskmyoo.medium.com/">Itskmyoo’s</a> tutorial, we’ll implement a similar CI/CD pipeline with minor adjustments tailored to our project. Below are the configurations you’ll need to get started.</p>
<section id="dockerfile-containerization" class="level4">
<h4 class="anchored" data-anchor-id="dockerfile-containerization">Dockerfile (Containerization)</h4>
<p>The Dockerfile is critical for containerizing our FastAPI app. Here’s the updated version for our project:</p>
<p>Filename: <a href="https://github.com/jospablo777/ml_model_api/blob/main/Dockerfile"><code>Dockerfile</code></a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode dockerfile code-with-copy"><code class="sourceCode dockerfile"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use an official Python runtime as a parent image</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> python:3.12-slim</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the working directory in the container</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /api_app</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Copy the requirements file into the container</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> requirements.txt /api_app/</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Install dependencies</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">pip</span> install <span class="at">--no-cache-dir</span> <span class="at">-r</span> requirements.txt</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Copy the project files into the container</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> . /api_app/</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Expose port 80 for external access</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPOSE</span> 80</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Define environment variable</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> NAME=ml-model-api-docker</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the maintainer label</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="kw">LABEL</span> maintainer=<span class="st">"jospablo777 &lt;jospablo777@gmail.com&gt;"</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the FastAPI app with Uvicorn</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">"uvicorn"</span>, <span class="st">"app.main:app"</span>, <span class="st">"--host"</span>, <span class="st">"0.0.0.0"</span>, <span class="st">"--port"</span>, <span class="st">"80"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="github-actions-workflow" class="level4">
<h4 class="anchored" data-anchor-id="github-actions-workflow">GitHub Actions Workflow</h4>
<p>The GitHub Actions workflow (<code>.github/workflows/main.yml</code>) automates testing, building, and pushing the Docker image to Docker Hub. Below is the configuration for our project:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode yml code-with-copy"><code class="sourceCode yaml"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> ML Model API - Test, build, and push</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">push</span><span class="kw">:</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> main</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">test</span><span class="kw">:</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Checkout code</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v2</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Set up Python</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/setup-python@v4</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">python-version</span><span class="kw">:</span><span class="at"> </span><span class="st">"3.12"</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install dependencies</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="fu">      run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>        python -m pip install --upgrade pip</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        pip install -r requirements.txt</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run tests</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span><span class="at"> pytest tests/ --cov=app</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">needs</span><span class="kw">:</span><span class="at"> test</span><span class="co"> # build job runs only if tests pass</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Checkout code</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v2</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Set up Docker Buildx</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> docker/setup-buildx-action@v1</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Login to Docker Hub</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span><span class="at"> echo ${{ secrets.DOCKERHUB_ACCESS_TOKEN }} | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Build and push Docker image</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a><span class="fu">      run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>        docker buildx create --use</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>        docker buildx build \</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>          --file Dockerfile \</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>          --tag jospablo777/ml-model-api:latest \</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>          --push .</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">DOCKER_CLI_EXPERIMENTAL</span><span class="kw">:</span><span class="at"> enabled</span></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">DOCKER_BUILDKIT</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The main modification was adding a testing section before the docker build.</p>
<section id="how-it-works" class="level5">
<h5 class="anchored" data-anchor-id="how-it-works">How It Works</h5>
<ol type="1">
<li><strong>Testing:</strong>
<ul>
<li>Runs on every push to the <code>main</code> branch.</li>
<li>Installs dependencies and runs <code>pytest</code> to verify the codebase, ensuring that only tested and reliable code proceeds to the build stage.</li>
</ul></li>
<li><strong>Building:</strong>
<ul>
<li>After passing the tests, the build job creates a Docker image using the specified <code>Dockerfile.</code></li>
<li>The image is tagged and pushed to Docker Hub.</li>
</ul></li>
<li><strong>Environment Variables:</strong>
<ul>
<li>The pipeline uses <code>DOCKERHUB_ACCESS_TOKEN</code> and <code>DOCKERHUB_USERNAME</code>, securely stored in GitHub Secrets, to authenticate with Docker Hub.</li>
</ul></li>
</ol>
</section>
</section>
<section id="final-steps" class="level4">
<h4 class="anchored" data-anchor-id="final-steps">Final Steps</h4>
<p>With the guidance from <a href="https://itskmyoo.medium.com/automating-fastapi-project-build-with-github-actions-and-push-to-dockerhub-b4c6df319b2a">Itskmyoo’s tutorial</a> and the customizations above, our CI/CD pipeline is ready to go. Every push to the <code>main</code> branch will:</p>
<ol type="1">
<li>Run automated tests.</li>
<li>Build a Docker image.</li>
<li>Push the image to Docker Hub for seamless deployment.</li>
</ol>
<p>This process is illustrated here:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/ci_cd_test_build.png" class="img-fluid figure-img"></p>
<figcaption>CI/CD configuration for our project</figcaption>
</figure>
</div>
<p>This setup ensures your application is always deployable and meets high-quality standards.</p>
</section>
</section>
</section>
<section id="automated-tests" class="level2">
<h2 class="anchored" data-anchor-id="automated-tests">Automated tests</h2>
<p>Although we touched on testing briefly in the CI/CD section, it’s time to dive deeper into this critical aspect of software development.</p>
<p>Automated testing is a cornerstone of modern software engineering practices. It accelerates the development process while ensuring the quality and reliability of the codebase. For example, imagine you need to refactor a clunky series of steps into a cleaner, more modular function. During this process, there’s always a risk of unintentionally introducing hard-to-detect bugs. This is where automated tests prove invaluable—they act as a safety net, quickly identifying errors and verifying that your changes didn’t break any existing functionality.</p>
<p>In this section, we’ll explore how automated tests are implemented in our project, focusing on key scenarios such as:</p>
<ul>
<li>Validating the functionality of the <code>/predict</code> endpoint.</li>
<li>Ensuring data transformation processes work as expected.</li>
<li>Verifying the behavior of the trained CatBoost model.</li>
</ul>
<p>Let’s dive into writing and running automated tests to ensure and enhance the quality of our FastAPI application! All test scripts are organized in the tests/ directory, categorized into three logical groups:</p>
<ul>
<li><strong>API tests:</strong> Validate the endpoints of our FastAPI app.</li>
<li><strong>Inference tests:</strong> Ensure the ML model behaves as expected during predictions.</li>
<li><strong>Unit tests:</strong> Test isolated components, such as helper functions or data transformations.</li>
</ul>
<section id="api-tests" class="level3">
<h3 class="anchored" data-anchor-id="api-tests">API tests</h3>
<p>While we won’t cover every example, feel free to explore the full test suite in the repository. For now, let’s focus on a test for the API.</p>
<p>Below is an example test for the /predict endpoint, which validates predictions for a single input row:</p>
<p>Filename: <a href="https://github.com/jospablo777/ml_model_api/blob/main/tests/test_api.py"><code>tests/test_api.py</code></a></p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-13"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-13-1"><a href="#annotated-cell-13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --snip--</span></span>
<span id="annotated-cell-13-2"><a href="#annotated-cell-13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-13-3"><a href="#annotated-cell-13-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Test the /predict endpoint with a single row</span></span>
<span id="annotated-cell-13-4"><a href="#annotated-cell-13-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_predict_rentals_single():</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-13-5" class="code-annotation-target"><a href="#annotated-cell-13-5" aria-hidden="true" tabindex="-1"></a>    payload <span class="op">=</span> {</span>
<span id="annotated-cell-13-6"><a href="#annotated-cell-13-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"season"</span>: <span class="st">"Summer"</span>,</span>
<span id="annotated-cell-13-7"><a href="#annotated-cell-13-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"mnth"</span>: <span class="st">"June"</span>,</span>
<span id="annotated-cell-13-8"><a href="#annotated-cell-13-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"hr"</span>: <span class="dv">14</span>,</span>
<span id="annotated-cell-13-9"><a href="#annotated-cell-13-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"holiday"</span>: <span class="st">"No"</span>,</span>
<span id="annotated-cell-13-10"><a href="#annotated-cell-13-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"weekday"</span>: <span class="st">"Monday"</span>,</span>
<span id="annotated-cell-13-11"><a href="#annotated-cell-13-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"workingday"</span>: <span class="st">"Yes"</span>,</span>
<span id="annotated-cell-13-12"><a href="#annotated-cell-13-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"weathersit"</span>: <span class="dv">1</span>,</span>
<span id="annotated-cell-13-13"><a href="#annotated-cell-13-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"temp"</span>: <span class="fl">0.78</span>,</span>
<span id="annotated-cell-13-14"><a href="#annotated-cell-13-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"atemp"</span>: <span class="fl">0.697</span>,</span>
<span id="annotated-cell-13-15"><a href="#annotated-cell-13-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"hum"</span>: <span class="fl">0.43</span>,</span>
<span id="annotated-cell-13-16"><a href="#annotated-cell-13-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"windspeed"</span>: <span class="fl">0.2537</span></span>
<span id="annotated-cell-13-17"><a href="#annotated-cell-13-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="annotated-cell-13-18"><a href="#annotated-cell-13-18" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> client.post(<span class="st">"/predict"</span>, json<span class="op">=</span>[payload])  </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-13-19" class="code-annotation-target"><a href="#annotated-cell-13-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> response.status_code <span class="op">==</span> <span class="dv">200</span></span>
<span id="annotated-cell-13-20"><a href="#annotated-cell-13-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"predictions"</span> <span class="kw">in</span> response.json()</span>
<span id="annotated-cell-13-21"><a href="#annotated-cell-13-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">isinstance</span>(response.json()[<span class="st">"predictions"</span>], <span class="bu">list</span>)</span>
<span id="annotated-cell-13-22"><a href="#annotated-cell-13-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-13-23"><a href="#annotated-cell-13-23" aria-hidden="true" tabindex="-1"></a><span class="co"># --snip--</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-13" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-13" data-code-lines="5,6,7,8,9,10,11,12,13,14,15,16,17" data-code-annotation="1"><strong>Simulates a Request</strong> Sends a single payload to the <code>/predict</code> endpoint, mimicking a real-world API request.</span>
</dd>
<dt data-target-cell="annotated-cell-13" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-13" data-code-lines="19,20,21" data-code-annotation="2"><strong>Validates the Response</strong></span>
</dd>
</dl>
</div>
</div>
<ul>
<li>Ensures the API returns a <code>200 OK</code> status, confirming successful processing.</li>
<li>Verifies that the response contains a <code>predictions</code> key.</li>
<li>Checks that the predictions are returned as a list, as expected.</li>
</ul>
<p>This test is important for ensuring the <code>/predict</code> endpoint handles individual requests correctly. By automating it, we safeguard against regressions whenever the API logic or underlying model is updated.</p>
<p>Let’s now move forward to explore other tests or dive deeper into how the inference logic is validated.</p>
</section>
<section id="inference-tests" class="level3">
<h3 class="anchored" data-anchor-id="inference-tests">Inference tests</h3>
<p>Inference tests are designed to verify that the predictive model is functioning correctly in terms of processing inputs and generating outputs. While these tests don’t evaluate whether the model’s predictions are accurate (a more complex task we will leave for the company data scientists<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a>), they ensure that the model receives the expected input features and produces predictions in the correct format.</p>
<p>The following is an example inference test:</p>
<p>File: <a href="https://github.com/jospablo777/ml_model_api/blob/main/tests/test_inference.py"><code>tests/test_inference.py</code></a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --snip--</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Test model prediction with a single row</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_model_single_prediction():</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> np.array([[<span class="st">"Summer"</span>, <span class="st">"June"</span>, <span class="dv">14</span>, <span class="st">"No"</span>, <span class="st">"Monday"</span>, <span class="st">"Yes"</span>, <span class="dv">1</span>, <span class="fl">0.78</span>, <span class="fl">0.697</span>, <span class="fl">0.43</span>, <span class="fl">0.2537</span>]])</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    prediction <span class="op">=</span> ml_model.predict(features)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> prediction <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">isinstance</span>(prediction, np.ndarray)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co"># --snip--</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol type="1">
<li><strong>Input Simulation</strong>
<ul>
<li>Creates a NumPy array representing a single row of input features for the predictive model.</li>
<li>Mimics real-world input data to ensure the test is practical and relevant.</li>
</ul></li>
<li><strong>Output Validation</strong>
<ul>
<li>Confirms that the model returns a valid prediction (i.e., not <code>None</code> or empty).</li>
<li>Verifies that the output is a NumPy array, as expected from the CatBoost model.</li>
</ul></li>
</ol>
<p>Inference tests are essential for detecting issues such as:</p>
<ul>
<li><strong>Input Format Errors:</strong> Ensuring the model can process the provided features without errors.</li>
<li><strong>Output Integrity:</strong> Verifying that predictions are returned in the correct data structure (e.g., NumPy array).</li>
<li><strong>Model Loading:</strong> Checking that the model is correctly loaded and operational.</li>
</ul>
</section>
<section id="running-the-tests" class="level3">
<h3 class="anchored" data-anchor-id="running-the-tests">Running the tests</h3>
<p>Running these tests with pytest is a breeze. You just need to go to the root of the project (in a terminal) and run <code>pytest folder_that_contain_the_tests/</code>. So, let’s run the tests:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pytest</span> tests/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If everything goes well, we will see an output like this output in our terminal:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">user@user-pc:~/ml_model_api$</span> pytest tests/</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">========================================</span> test session starts =========================================</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="ex">platform</span> linux <span class="at">--</span> Python 3.12.3, pytest-8.3.4, pluggy-1.5.0</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="ex">rootdir:</span> ~/ml_model_api</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="ex">plugins:</span> anyio-4.7.0, cov-6.0.0</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="ex">collected</span> 12 items                                                                                   </span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="ex">tests/test_api.py</span> .....                                                                        [ 41%]</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="ex">tests/test_inference.py</span> ...                                                                    [ 66%]</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="ex">tests/test_unit.py</span> ....                                                                        <span class="pp">[</span><span class="ss">100%</span><span class="pp">]</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="ex">=========================================</span> 12 passed in 0.58s =========================================</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>All three set of tests were successful.</p>
<p>By running these tests, we gain confidence that the model pipeline is intact and ready for deployment. While further evaluation of the model’s predictions may require additional analysis by data scientists, our automated tests ensure that the system behaves as expected and is free from structural issues. With this strong foundation, we can now move on to deploying and running the microservice.</p>
</section>
</section>
<section id="microservice-up-and-running" class="level2">
<h2 class="anchored" data-anchor-id="microservice-up-and-running">Microservice up and running</h2>
<p>Once the application passes all tests, it’s time to deploy the microservice and get it running. To simplify this process, we’ve containerized the application using Docker, making it easy to share, run, and scale across different environments.</p>
<p>For this project, you can use the pre-built Docker image hosted on Docker Hub to quickly get the application up and running on your machine. The following steps will guide you through the deployment process:</p>
<ol type="1">
<li><strong>Pull the Pre-Built Docker Image:</strong> Download the image directly from Docker Hub.</li>
<li><strong>Run the Docker Container:</strong> Start the containerized application with a single command.</li>
<li><strong>Access the API:</strong> Use the provided endpoints to interact with the microservice.</li>
</ol>
<p>Let’s dive into each step!</p>
<section id="step-1-pull-the-image-from-docker-hub" class="level3">
<h3 class="anchored" data-anchor-id="step-1-pull-the-image-from-docker-hub">Step 1: Pull the Image from Docker Hub</h3>
<p>Run the following command to download the image:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> pull jospablo777/ml-model-api:latest</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-2-run-the-docker-container" class="level3">
<h3 class="anchored" data-anchor-id="step-2-run-the-docker-container">Step 2: Run the Docker Container</h3>
<p>Start the container with the following command:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-d</span> <span class="at">-p</span> 8000:80 <span class="at">--name</span> bike-sharing-api jospablo777/ml-model-api:latest</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-3-access-the-api" class="level3">
<h3 class="anchored" data-anchor-id="step-3-access-the-api">Step 3: Access the API</h3>
<p>The API will be accessible at:</p>
<ul>
<li>Base URL: <a href="http://127.0.0.1:8000">http://127.0.0.1:8000</a></li>
<li>Swagger UI: <a href="http://127.0.0.1:8000/docs">http://127.0.0.1:8000/docs</a></li>
<li>ReDoc: <a href="http://127.0.0.1:8000/redoc">http://127.0.0.1:8000/redoc</a></li>
</ul>
<p>You can now send requests to the API, such as <code>POST</code> requests to <code>/predict</code> for bike rental predictions.</p>
<p>With the microservice deployed and running successfully, you can now interact with the API to make predictions. The <code>/predict</code> endpoint allows you to send input data and receive predictions about bike rentals in real time. This brings us to the heart of the system: <strong>inference</strong>.</p>
</section>
</section>
<section id="inference" class="level2">
<h2 class="anchored" data-anchor-id="inference">Inference</h2>
<p>Inference is the process of using the trained machine learning model to generate predictions based on input data. With the /predict endpoint, our FastAPI application makes it easy to perform real-time predictions for bike rentals.</p>
<section id="example-making-a-prediction" class="level3">
<h3 class="anchored" data-anchor-id="example-making-a-prediction">Example: Making a Prediction</h3>
<p>To test the inference process, you can send a <code>POST</code> request to the <code>/predict</code> endpoint with the required input features. Here’s an example using <code>curl</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> POST <span class="st">"http://127.0.0.1:8000/predict"</span> <span class="dt">\</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>-H <span class="st">"Content-Type: application/json"</span> <span class="dt">\</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>-d <span class="st">'[</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="st">    {</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="st">        "season": "Summer",</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="st">        "mnth": "June",</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="st">        "hr": 14,</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="st">        "holiday": "No",</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="st">        "weekday": "Monday",</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="st">        "workingday": "Yes",</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="st">        "weathersit": 1,</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="st">        "temp": 0.78,</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="st">        "atemp": 0.697,</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="st">        "hum": 0.43,</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="st">        "windspeed": 0.2537</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="st">]'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The server will respond with a prediction:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"predictions"</span><span class="fu">:</span> <span class="ot">[</span><span class="fl">225.755</span><span class="ot">]</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This inference process demonstrates the power of combining machine learning with FastAPI. By containerizing and exposing the model through an API, we’ve created a flexible, efficient way to generate predictions in real-time. Whether for testing, integrating into other systems, or deploying to production, this pipeline ensures the model’s predictions are accessible and easy to use.</p>
</section>
</section>
<section id="whats-left" class="level2">
<h2 class="anchored" data-anchor-id="whats-left">Whats left?</h2>
<p>In this project, we only scratched the surface of the many software engineering and MLOps practices that can elevate our workflows, improve delivery processes, and increase the value we generate as data professionals. While we covered foundational concepts like API development, containerization, and CI/CD, there’s so much more to explore when it comes to bridging the gap between machine learning and production-ready systems.</p>
<p>I hope that in future tutorials and practical projects we can deep dive more in MLOps subjects like:</p>
<ul>
<li><strong>Model Monitoring:</strong> Continuously tracking model performance in production to detect data drift, monitor accuracy, and ensure reliability over time.</li>
<li><strong>Automated Retraining in CI/CD:</strong> Incorporating automatic model retraining pipelines into the CI/CD process to seamlessly update models based on new data.</li>
<li><strong>Model Versioning:</strong> Managing multiple versions of models to track changes, enable rollbacks when necessary, and ensure reproducibility in machine learning workflows.</li>
<li><strong>Feature Stores:</strong> Centralizing feature engineering pipelines to create reusable, consistent features for training and inference.</li>
</ul>
<p>These practices are at the heart of MLOps and represent the next steps toward creating robust, scalable, and maintainable machine learning systems. Stay tuned for more in-depth tutorials and practical projects that will dive into these topics!</p>
</section>
<section id="what-we-learned" class="level2">
<h2 class="anchored" data-anchor-id="what-we-learned">What we learned?</h2>
<p>WWow! That was a lot of information and code to dive into, wasn’t it?</p>
<p>Throughout this project, we explored the end-to-end process of developing a machine learning microservice. Hopefully, you’ve picked up a few valuable skills and techniques to enhance your workflow as a data professional. Here’s a quick recap of what we covered:</p>
<ol type="1">
<li><p>Building an API with FastAPI:</p>
<ul>
<li>We created endpoints, validated input data with Pydantic models, and exposed our machine learning model through a <code>/predict</code> API.</li>
</ul></li>
<li><p>Containerizing Applications:</p>
<ul>
<li>Using Docker, we learned how to build a portable, scalable container for our app, complete with a pre-built image on Docker Hub.</li>
</ul></li>
<li><p>Automated Testing:</p>
<ul>
<li>We implemented unit, inference, and API tests to ensure our app is robust and reliable, catching issues before deployment.</li>
</ul></li>
<li><p>CI/CD Pipelines:</p>
<ul>
<li>By leveraging GitHub Actions, we automated the testing, building, and deployment process, making our development cycle more efficient.</li>
</ul></li>
<li><p>Real-Time Predictions:</p>
<ul>
<li>Through inference, we demonstrated how to use the trained CatBoost model to generate predictions in real-time via a FastAPI endpoint.</li>
</ul></li>
</ol>
<p>This journey showcased how modern tools and best practices in software engineering can streamline machine learning workflows, from development to deployment.</p>
<section id="closing-thoughts" class="level3">
<h3 class="anchored" data-anchor-id="closing-thoughts">Closing Thoughts</h3>
<p>Whether you’re building ML-powered APIs, automating pipelines, or just exploring FastAPI and Docker, these skills are a great foundation for developing scalable, production-ready solutions. If you have questions, ideas, or feedback, feel free to reach out—I’d love to hear from you!</p>
<p>Thank you for following along, and happy coding! 🚀</p>
</section>
</section>
<section id="about-the-pondering-guy-in-the-header" class="level2">
<h2 class="anchored" data-anchor-id="about-the-pondering-guy-in-the-header">About the pondering guy in the header</h2>
<p>It’s the wizard from “Pondering My Orb.” The art is the work by Angus Mcbride and was featured in a Lord of the Rings game book :) you can check <a href="https://knowyourmeme.com/memes/pondering-my-orb">Know Your Meme</a> for more info/memes.</p>
</section>
<section id="citation" class="level2">
<h2 class="anchored" data-anchor-id="citation">Citation</h2>
<p>No citation is required, but if you found this project helpful, I’d greatly appreciate a mention! 😄</p>
<p>If you’re in Costa Rica, let’s connect over a cup of tea or a beer and have a data-filled chat! Feel free to reach out to me on LinkedIn: <a href="https://www.linkedin.com/in/jose-barrantes/">José Pablo Barrantes</a></p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>This must be how George R. R. Martin feels when foreshadowing a major (traumatic) event in his novels.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>At the time of writing, I am aware that “no” is the answer since we’re still just at the introduction of this tutorial.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>It’s even worse today, in our modern remote era. The dreaded Microsoft Teams ringtone will constantly haunt you.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>You probably already noticed that we keep bringing up the link to this notebook. That’s because we spent so much time on it, and we was hoping you could look at our precious.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>I learned this tip for technical writing from “The Rust Programming Language” book by Steve Klabnik, Carol Nichols, and the Rust Community. The book is a masterpiece and a highly recommended reading; you can find it <a href="https://doc.rust-lang.org/book/title-page.html">here</a>.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>Whoops, here is the notebook again. When presenting results to my stakeholders as a habit, I always prepare two decks, one with very high-level results and a second highly technical one with all the math of the statistical/ML models and intricacies of the system design, just in case somebody has a question on the <span style="text-decoration: line-through;">interesting</span> technical part. This is expecting a deep, nerdy discussion about models, gaps, opportunities, and science; to date, the counts for the times I’ve used this second deck remain at 0. The good news is that it might be a proxy of our stakeholders’ trust in us.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>エンチラーダをいただけますか？<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p>A decorator is a function whose intention is to modify the behavior of other functions; it takes the original function and converts it into a different function. Luciano Ramalho does a great job explaining decorators in chapter 9 of his book <a href="https://www.oreilly.com/library/view/fluent-python-2nd/9781492056348/">“Fluent Python”</a>.<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9"><p>Probably you, as there aren’t many.<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>